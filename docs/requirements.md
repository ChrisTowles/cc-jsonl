# 要件定義書

## 1. システム概要

Claude Codeのチャットログを監視・保存し、Webインターフェースで表示・操作するシステム。2つの独立したサービスで構成される。

## 2. システム構成

### 2.1 アーキテクチャ
- **サービス分離**: 監視サービスとWebアプリケーションサービスを独立して起動可能
- **アーキテクチャパターン**: ヘキサゴナルアーキテクチャ（ドメイン駆動設計）
- **UI設計**: モバイルファーストデザイン

### 2.2 サービス構成
1. **チャットログ監視サービス** - ファイル監視とデータベース保存
2. **Webアプリケーションサービス** - データ表示とClaude Code SDK連携

## 3. 機能要件

### 3.1 チャットログ監視サービス

#### 3.1.1 ファイル監視機能
- **対象ファイルパターン**: `${target}/${projectName}/${sessionId}.json*`
- **監視対象**: Claude Codeのチャットログファイル
- **監視方式**: リアルタイムファイル監視
- **処理内容**: 新規ファイル作成・更新の検知

#### 3.1.2 データ保存機能
- **データベース**: SQLite with Drizzle ORM
- **保存データ**: プロジェクト情報、セッション情報、チャットログ
- **データ構造**: 
  - プロジェクト（Project）
  - セッション（Session）
  - メッセージ（Message）

#### 3.1.3 データモデル
```typescript
// Project
- id: string (UUID)
- name: string
- targetPath: string
- createdAt: Date
- updatedAt: Date

// Session  
- id: string (UUID)
- projectId: string
- sessionId: string (Claude Code session ID)
- createdAt: Date
- updatedAt: Date

// Message
- id: string (UUID)
- sessionId: string
- content: string
- role: 'user' | 'assistant'
- timestamp: Date
- createdAt: Date
- updatedAt: Date
```

### 3.2 Webアプリケーションサービス

#### 3.2.1 プロジェクト管理機能
- **プロジェクト一覧表示**: 監視対象プロジェクトの一覧
- **プロジェクト選択**: 特定プロジェクトの選択・表示
- **プロジェクト情報表示**: プロジェクト名、セッション数等の基本情報

#### 3.2.2 セッション管理機能
- **セッション一覧表示**: 選択プロジェクト内のセッション一覧
- **セッション選択**: 特定セッションの選択・表示
- **セッション情報表示**: セッションID、メッセージ数、最終更新日時等

#### 3.2.3 チャットルーム機能
- **チャット履歴表示**: 選択セッションのメッセージ履歴
- **リアルタイム表示**: データベースデータと新規メッセージの統合表示
- **メッセージ形式**: ユーザー・アシスタントメッセージの区別表示
- **タイムスタンプ表示**: メッセージの送信時刻表示

#### 3.2.4 Claude Code SDK連携機能

##### 3.2.4.1 既存セッション連携
- **セッション指定送信**: 特定のセッションIDに対するメッセージ送信
- **コンテキスト維持**: 既存セッションのコンテキストを保持した会話継続

##### 3.2.4.2 新規セッション作成
- **ディレクトリ指定**: 実行ディレクトリを指定した新規セッション作成
- **セッションID未指定**: セッションIDなしでの新規セッション開始

#### 3.2.5 リアルタイム通信機能
- **ReadableStream処理**: Claude Code SDKからのストリーミングレスポンス処理
- **データ統合**: データベースデータとリアルタイムレスポンスの破綻のない統合表示
- **状態管理**: 送信中・受信中・完了状態の適切な管理

#### 3.2.6 ユーザーインターフェース機能
- **モバイルファースト**: スマートフォン・タブレット対応の responsive デザイン
- **ナビゲーション**: プロジェクト → セッション → チャットルームの階層ナビゲーション
- **リアルタイム更新**: 新規メッセージの自動表示更新

## 4. 非機能要件

### 4.1 パフォーマンス要件
- **ファイル監視**: リアルタイム監視（遅延1秒以内）
- **データベース応答**: 一覧表示500ms以内
- **UI応答性**: モバイルデバイスでの操作レスポンス200ms以内

### 4.2 可用性要件
- **サービス独立性**: 各サービスの独立起動・停止
- **障害耐性**: 一方のサービス停止時の他方への影響最小化

### 4.3 拡張性要件
- **複数プロジェクト**: 複数のClaude Codeプロジェクトの同時監視
- **並行セッション**: 複数セッションの同時操作

### 4.4 セキュリティ要件
- **ファイルアクセス**: 指定ディレクトリ内のファイルのみアクセス
- **API通信**: Claude Code SDK経由の安全な通信

## 5. 技術要件

### 5.1 開発環境
- **Runtime**: Node.js 22.x
- **Frontend**: Next.js 15 with React 19
- **UI Framework**: Tailwind CSS v4, shadcn/ui
- **Database**: SQLite with Drizzle ORM
- **Validation**: Zod 4 schemas with branded types
- **Error Handling**: neverthrow for Result types

### 5.2 外部依存
- **Claude Code SDK**: https://github.com/anthropics/claude-code
- **ファイルシステム**: ローカルファイルシステムへのアクセス

## 6. データフロー

### 6.1 監視サービス
1. ファイルシステム監視
2. 変更検知
3. ファイル内容解析
4. データベース保存

### 6.2 Webアプリケーション
1. データベースからデータ取得
2. UI表示
3. ユーザー操作（メッセージ送信）
4. Claude Code SDK経由でメッセージ送信
5. リアルタイムレスポンス受信・表示

## 7. エラーハンドリング

### 7.1 監視サービスエラー
- **ファイルアクセスエラー**: ログ出力、監視継続
- **データベースエラー**: リトライ処理、エラーログ
- **JSON解析エラー**: スキップ処理、エラーログ

### 7.2 Webアプリケーションエラー
- **Claude Code SDK エラー**: ユーザーへのエラー表示、リトライ機能
- **ネットワークエラー**: 自動リトライ、接続状態表示
- **データベースエラー**: エラー表示、再読み込み機能
