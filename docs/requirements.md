# 機能要件定義書

## 1. システム概要

Claude Codeのチャットログを監視・保存し、Webインターフェースで表示・操作するシステム。2つの独立したサービスで構成される。

## 2. システム構成

### 2.1 サービス構成

1. **チャットログ監視サービス** - ファイル監視とデータベース保存
2. **Webアプリケーションサービス** - データ表示とClaude Code SDK連携

### 2.2 基本要件

- **サービス分離**: 監視サービスとWebアプリケーションサービスを独立して起動可能
- **UI設計**: モバイルファーストデザイン

## 3. 機能要件

### 3.1 チャットログ監視サービス

#### 3.1.1 ファイル監視機能

- **対象ファイルパターン**: `${target}/${projectName}/${sessionId}.jsonl`
- **監視対象**: Claude Codeのチャットログファイル（JSON Lines形式）
- **監視方式**: リアルタイムファイル監視
- **処理内容**: 新規ファイル作成・更新の検知

#### 3.1.2 データ保存機能

- **保存データ**: プロジェクト情報、セッション情報、チャットログ
- **データ構造**:
    - プロジェクト（Project）
    - セッション（Session）
    - メッセージ（Message）
- **メッセージ形式対応**: パースできない形式のメッセージも保存できること
- **Tool対応**: 未知のToolでもパースできること

### 3.2 Webアプリケーションサービス

#### 3.2.1 プロジェクト管理機能

- **プロジェクト一覧表示**: 監視対象プロジェクトの一覧
- **プロジェクト選択**: 特定プロジェクトの選択・表示
- **プロジェクト情報表示**: プロジェクト名、セッション数等の基本情報

#### 3.2.2 セッション管理機能

- **セッション一覧表示**: 選択プロジェクト内のセッション一覧
- **セッション選択**: 特定セッションの選択・表示
- **セッション情報表示**: セッションID、メッセージ数、最終更新日時等

#### 3.2.3 チャットルーム機能

- **チャット履歴表示**: 選択セッションのメッセージ履歴
- **リアルタイム表示**: 保存済みデータと新規メッセージの統合表示
- **メッセージ形式**: ユーザー・アシスタントメッセージの区別表示
- **タイムスタンプ表示**: メッセージの送信時刻表示

#### 3.2.4 Claude Code SDK連携機能

##### 3.2.4.1 既存セッション連携

- **セッション指定送信**: 特定のセッションIDに対するメッセージ送信
- **コンテキスト維持**: 既存セッションのコンテキストを保持した会話継続

##### 3.2.4.2 新規セッション作成

- **ディレクトリ指定**: 実行ディレクトリを指定した新規セッション作成
- **セッションID未指定**: セッションIDなしでの新規セッション開始

#### 3.2.5 リアルタイム通信機能

- **ストリーミング処理**: Claude Code SDKからのストリーミングレスポンス処理
- **データ統合**: 保存済みデータとリアルタイムレスポンスの破綻のない統合表示
- **状態管理**: 送信中・受信中・完了状態の適切な管理

#### 3.2.6 ユーザーインターフェース機能

- **モバイルファースト**: スマートフォン・タブレット対応の responsive デザイン
- **ナビゲーション**: プロジェクト → セッション → チャットルームの階層ナビゲーション
- **リアルタイム更新**: 新規メッセージの自動表示更新

## 4. データフロー

### 4.1 監視サービス

1. ファイルシステム監視
2. 変更検知
3. ファイル内容解析
4. データベース保存

### 4.2 Webアプリケーション

1. データベースからデータ取得
2. UI表示
3. ユーザー操作（メッセージ送信）
4. Claude Code SDK経由でメッセージ送信
5. リアルタイムレスポンス受信・表示
